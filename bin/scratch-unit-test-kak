#! /bin/sh

root_dir="$( ( cd "${0%/*}/.."; pwd ) )"

SCRATCH_UNIT_TEST_PRELUDE_SH="$(cat "$root_dir/lib/prelude.sh")"
export SCRATCH_UNIT_TEST_PRELUDE_SH
eval "$SCRATCH_UNIT_TEST_PRELUDE_SH"

SCRATCH_UNIT_TEST_SEND_MESSAGE="$(cat "$root_dir/lib/send_message.sh")"
export SCRATCH_UNIT_TEST_SEND_MESSAGE

TRANSLATOR="$root_dir/lib/scratch_unit_test_translate"

scratch_dir=$(mktemp -d "${TMPDIR:-/tmp}/scratch-unit-test-kak.XXXXXXXX")

clean_up () {
    code=$?
    rm -r "$scratch_dir"
    exit $code
}

trap clean_up EXIT

SCRATCH_UNIT_TEST_DIR="$scratch_dir"
export SCRATCH_UNIT_TEST_DIR

mkfifo "$SCRATCH_UNIT_TEST_DIR/fifo"

if ! test -x "$TRANSLATOR" >/dev/null; then
    echo "${0##*/}: missing executable \"$TRANSLATOR\"";
    exit 1;
fi >&2

# Listen to the fifo.
"$TRANSLATOR" "$SCRATCH_UNIT_TEST_DIR/fifo" &

# Keep the fifo open.
sleep 100000d >"$SCRATCH_UNIT_TEST_DIR/fifo" 2>&1 </dev/null &
fifo_holder_pid=$!

{
    kak_quote source "$root_dir/rc/scratch-unit-test.kak"
    kak_quote source "$root_dir/rc/scratch-commands.kak"
    kak_quote buffer '*debug*'
    for argument
    do
        kak_quote try "$(kak_quote source "$argument")"
    done
    kak_quote require-module scratch-unit-test
    kak_quote scratch-unit-test-send message_quit
} >"$SCRATCH_UNIT_TEST_DIR/source.kak"

kak -ui dummy -n -e 'source %sh(printf "%s" "$SCRATCH_UNIT_TEST_DIR/source.kak")'
kak_status=$?

if test "$fifo_holder_pid" -gt 0; then
    kill "$fifo_holder_pid"
fi

cat "$SCRATCH_UNIT_TEST_DIR/debug"

exit "$kak_status"
