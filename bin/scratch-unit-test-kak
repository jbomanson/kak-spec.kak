#! /bin/sh

SCRATCH_UNIT_TEST_PRELUDE_SH="$(cat "${0%/*}/../lib/prelude.sh")"
export SCRATCH_UNIT_TEST_PRELUDE_SH

scratch_dir=$(mktemp -d "${TMPDIR:-/tmp}/scratch-unit-test-kak.XXXXXXXX")

clean_up () {
    code=$?
    rm -r "$scratch_dir"
    exit $code
}

trap clean_up EXIT

SCRATCH_UNIT_TEST_DIR="$scratch_dir"
export SCRATCH_UNIT_TEST_DIR

mkfifo "$SCRATCH_UNIT_TEST_DIR/fifo"

PATH="${0%/*}/../rc/scratch-unit-test:$PATH"
if ! which "scratch_unit_test_translate" >/dev/null; then
    echo "${0##*/}: missing executable \"scratch_unit_test_translate\"";
    exit 1;
fi >&2

# Listen to the fifo.
{
    scratch_unit_test_translate \
        "$SCRATCH_UNIT_TEST_DIR/fifo" \
        >"$SCRATCH_UNIT_TEST_DIR/log" \
        2>&1
} >/dev/null 2>&1 </dev/null &

# Keep the fifo open.
sleep 100000d >"$SCRATCH_UNIT_TEST_DIR/fifo" 2>&1 </dev/null &
fifo_holder_pid=$!

kak -ui dummy -n -e '
    try %(
        source ~/a/scratch-unit-test.kak/rc/scratch-unit-test.kak
        source ~/a/scratch-unit-test.kak/rc/scratch-commands.kak
        source ~/a/scratch-unit-test.kak/sample-test-suites/simple.kak
    )
    buffer *debug*
    write /tmp/debug.txt
    hook global NormalIdle .* quit
'

if test -p "$SCRATCH_UNIT_TEST_DIR/fifo"; then
    printf "%s\n" "quit" >"$SCRATCH_UNIT_TEST_DIR/fifo"
fi
if test "$fifo_holder_pid" -gt 0; then
    kill "$fifo_holder_pid"
fi

cat /tmp/debug.txt
cat "$scratch_dir/log"
